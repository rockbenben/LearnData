import{aB as O,k as c,aw as E,ai as g,al as a,aC as p,l as v,e as T,at as m,au as y,am as l,aD as L,an as b,aE as F,aF as S,i as $,aG as D}from"./vidstack-Q8NlvF8c-wnQrPx0g.js";import{VideoProvider as I}from"./vidstack-video-GyX63bHt.js";import{R as C}from"./vidstack-WmYumZve-P--3YaZT.js";import"./app-j_BNNnD0.js";import"./vidstack-html-yf8r5jEt.js";const _=o=>D(o);class A{constructor(t){this.Ob=null,this.Wg=null,this.y={},this.z=new Set,this.$a=t}get instance(){return this.Ob}setup(t,i){this.F=i;const e=g(i.$state.streamType).includes("live"),r=g(i.$state.streamType).includes("ll-");this.Ob=new t({lowLatencyMode:r,backBufferLength:r?4:e?8:void 0,renderTextTracksNatively:!1,...this.y});const s=this.Xg.bind(this);for(const h of Object.values(t.Events))this.Ob.on(h,s);this.Ob.on(t.Events.ERROR,this.Ia.bind(this));for(const h of this.z)h(this.Ob);i.player.dispatch(new a("hls-instance",{detail:this.Ob})),this.Ob.attachMedia(this.$a),this.Ob.on(t.Events.AUDIO_TRACK_SWITCHED,this.Yg.bind(this)),this.Ob.on(t.Events.LEVEL_SWITCHED,this.Zg.bind(this)),this.Ob.on(t.Events.LEVEL_LOADED,this._g.bind(this)),this.Ob.on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.$g.bind(this)),this.Ob.on(t.Events.CUES_PARSED,this.ah.bind(this)),i.qualities[p.Ka]=this.bh.bind(this),v(i.qualities,"change",this.ra.bind(this)),v(i.audioTracks,"change",this.ch.bind(this)),this.Wg=T(this.dh.bind(this))}dh(){if(!this.F.$state.live())return;const t=new C(this.eh.bind(this));return t.Ja(),t.Ma.bind(t)}eh(){var t;this.F.$state.liveSyncPosition.set(((t=this.Ob)==null?void 0:t.liveSyncPosition)??1/0)}Xg(t,i){var e;(e=this.F.player)==null||e.dispatch(new a(_(t),{detail:i}))}$g(t,i){const e=new a(t,{detail:i});let r=-1;for(let s=0;s<i.tracks.length;s++){const h=i.tracks[s],n=h.subtitleTrack??h.closedCaptions,u=new m({id:`hls-${h.kind}${s}`,src:n==null?void 0:n.url,label:h.label,language:n==null?void 0:n.lang,kind:h.kind});u[y.Sb]=2,u[y.fc]=()=>{u.mode==="showing"?(this.Ob.subtitleTrack=s,r=s):r===s&&(this.Ob.subtitleTrack=-1,r=-1)},h.default&&u.setMode("showing",e),this.F.textTracks.add(u,e)}}ah(t,i){const e=this.F.textTracks.getById(`hls-${i.track}`);if(!e)return;const r=new a(t,{detail:i});for(const s of i.cues)s.positionAlign="auto",e.addCue(s,r)}Yg(t,i){const e=this.F.audioTracks[i.id];e&&this.F.audioTracks[l.Ga](e,!0,new a(t,{detail:i}))}Zg(t,i){const e=this.F.qualities[i.level];e&&this.F.qualities[l.Ga](e,!0,new a(t,{detail:i}))}_g(t,i){if(this.F.$state.canPlay())return;const{type:e,live:r,totalduration:s,targetduration:h}=i.details,n=new a(t,{detail:i});this.F.delegate.A("stream-type-change",r?e==="EVENT"&&Number.isFinite(s)&&h>=10?"live:dvr":"live":"on-demand",n),this.F.delegate.A("duration-change",s,n);const u=this.Ob.media;this.Ob.currentLevel===-1&&this.F.qualities[p.La](!0,n);for(const d of this.Ob.audioTracks)this.F.audioTracks[l.h]({id:d.id+"",label:d.name,language:d.lang||"",kind:"main"},n);for(const d of this.Ob.levels)this.F.qualities[l.h]({id:(d.id??d.height+"p")+"",width:d.width,height:d.height,codec:d.codecSet,bitrate:d.bitrate},n);u.dispatchEvent(new a("canplay",{trigger:n}))}Ia(t,i){var e,r,s;if(i.fatal)switch(i.type){case"networkError":(e=this.Ob)==null||e.startLoad();break;case"mediaError":(r=this.Ob)==null||r.recoverMediaError();break;default:(s=this.Ob)==null||s.destroy(),this.Ob=null;break}}bh(){this.Ob&&(this.Ob.currentLevel=-1)}ra(){const{qualities:t}=this.F;!this.Ob||t.auto||(this.Ob[t.switch+"Level"]=t.selectedIndex,L&&(this.$a.currentTime=this.$a.currentTime))}ch(){const{audioTracks:t}=this.F;this.Ob&&this.Ob.audioTrack!==t.selectedIndex&&(this.Ob.audioTrack=t.selectedIndex)}D(){var t,i;this.F&&(this.F.qualities[p.Ka]=void 0),(t=this.Ob)==null||t.destroy(),this.Ob=null,(i=this.Wg)==null||i.call(this),this.Wg=null}}class R{constructor(t,i,e){this.ug=t,this.F=i,this.hh=e,this.fh()}async fh(){const t={onLoadStart:this.Fg.bind(this),onLoaded:this.Ng.bind(this),onLoadError:this.gh.bind(this)};let i=await H(this.ug,t);if(b(i)&&!c(this.ug)&&(i=await N(this.ug,t)),!i)return null;if(!i.isSupported()){const e="[vidstack]: `hls.js` is not supported in this environment";return this.F.player.dispatch(new a("hls-unsupported")),this.F.delegate.A("error",{message:e,code:4}),null}return i}Fg(){this.F.player.dispatch(new a("hls-lib-load-start"))}Ng(t){this.F.player.dispatch(new a("hls-lib-loaded",{detail:t})),this.hh(t)}gh(t){const i=F(t);this.F.player.dispatch(new a("hls-lib-load-error",{detail:i})),this.F.delegate.A("error",{message:i.message,code:4})}}async function N(o,t={}){var i,e,r,s,h;if(!b(o)){if((i=t.onLoadStart)==null||i.call(t),o.prototype&&o.prototype!==Function)return(e=t.onLoaded)==null||e.call(t,o),o;try{const n=(r=await o())==null?void 0:r.default;if(n&&n.isSupported)(s=t.onLoaded)==null||s.call(t,n);else throw Error("");return n}catch(n){(h=t.onLoadError)==null||h.call(t,n)}}}async function H(o,t={}){var i,e,r;if(c(o)){(i=t.onLoadStart)==null||i.call(t);try{if(await S(o),!$(window.Hls))throw Error("");const s=window.Hls;return(e=t.onLoaded)==null||e.call(t,s),s}catch(s){(r=t.onLoadError)==null||r.call(t,s)}}}const q="https://cdn.jsdelivr.net",f=class f extends I{constructor(){super(...arguments),this.$$PROVIDER_TYPE="HLS",this.x=null,this.v=new A(this.video),this.w=`${q}/npm/hls.js@^1.0.0/dist/hls.min.js`}get ctor(){return this.x}get instance(){return this.v.instance}get type(){return"hls"}get canLiveSync(){return!0}get config(){return this.v.y}set config(t){this.v.y=t}get library(){return this.w}set library(t){this.w=t}preconnect(){c(this.w)&&E(this.w)}setup(t){super.setup(t),new R(this.w,t,i=>{this.x=i,this.v.setup(i,t),t.delegate.A("provider-setup",this);const e=g(t.$state.source);e&&this.loadSource(e)})}async loadSource(t,i){var e;c(t.src)&&(this.B.preload=i||"",(e=this.v.instance)==null||e.loadSource(t.src),this.C=t)}onInstance(t){const i=this.v.instance;return i&&t(i),this.v.z.add(t),()=>this.v.z.delete(t)}destroy(){this.v.D()}};f.supported=O();let w=f;export{w as HLSProvider};
